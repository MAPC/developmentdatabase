%h1.ui.header.page-header
  = @search.title

#map{style: 'height: 360px; width: 750px;'}

%table.ui.celled.table.unstackable
  %thead
    %tr
      %th
      - @search.status_keys.each do |name|
        %th= name.titleize
  %tbody
    %tr.active
      %td
        Total number of projects
      - @search.status_keys.each do |key|
        %td.right.aligned= @search.statuses.send(key).fetch(:count)
    - @search.numeric_fields.each do |field|
      %tr
        %td= Development.human_attribute_name field
        - @search.status_keys.each do |key|
          - stat = @search.statuses.send(key)
          - if stat.fetch(:count) == 0
            %td.right.aligned -
          - else
            %td.right.aligned= stat.fetch(field).round(0) { '-' }


%table.ui.celled.table.unstackable
  %thead
    %tr
      %th
      - @search.status_keys.each do |name|
        %th= name.titleize
  %tbody
    %tr.active
      %td
        Total number of projects
      - @search.status_keys.each do |key|
        %td.right.aligned= @search.statuses.send(key).fetch(:count)
    - @search.boolean_fields.each do |field|
      %tr
        %td= Development.human_attribute_name field
        - @search.status_keys.each do |key|
          - stat = @search.statuses.send(key)
          - if stat.fetch(:count) == 0
            %td.center.aligned -
          - else
            %td.right.aligned
              #{stat.fetch(field)} (#{ ((stat.fetch(field) / stat.fetch(:count).to_f) * 100).round(2) }%)


#footer
  %p
    Generated on
    = Time.now.to_s(:timestamp)
    by
    = link_to "Development Database (#{root_url})", root_url
  %p
    Criteria used:
  %ul
    - @search.criteria.each do |field, v|
      %li #{Development.human_attribute_name(field)} = #{v}
  %p
    View the latest version of this report at
    = link_to search_url(@search), @search
  -# NOT QUITE READY
  -# %p
  -#   View and refine this search at
  -#   - search_url = developments_url(@search.query)
  -#   = link_to search_url, search_url
  %p
    Download the data from this report at
    - csv_url = search_url(@search, { format: :csv })
    = link_to csv_url, csv_url

%br
%br

-# TODO: Provide a link to DD itself from here.

:javascript

  var map = L.map('map', { zoomControl:false }).setView([42.359,-71.137], 10);
  const ATTRIBUTION = 'Map tiles by <a href="http://mapc.org">MAPC</a>, ' +
                  'Data by <a href="http://www.mass.gov/mgis/">MassGIS</a>.';

  L.tileLayer('http://tiles.mapc.org/basemap/{z}/{x}/{y}.png', {
    minZoom: 9,
    maxZoom: 17,
    attribution: ATTRIBUTION
  }).addTo(map);

  var markers = [#{
    @search.results.map(&:location)
      .map { |loc| "L.marker(#{loc})" }.join(', ')
  }]

  var group = new L.featureGroup(markers).addTo(map);

  map.fitBounds(group.getBounds());
