%h1.ui.header.page-header
  = @search.try :title
%h3 Development Search Summary

#map{style: 'height: 360px; width: 750px;'}

%h4 Housing units and floor area uses, by project status

%table.ui.celled.table.unstackable
  %thead
    %tr
      %th
      - @search.status_keys.each do |name|
        %th= name.titleize
  %tbody
    %tr.active
      %td
        Total number of projects
      - @search.status_keys.each do |key|
        %td.right.aligned= @search.statuses.send(key).fetch(:count)
    - @search.numeric_fields.each do |field|
      %tr
        %td= Development.human_attribute_name field
        - @search.status_keys.each do |key|
          - stat = @search.statuses.send(key)
          - if stat.fetch(:count) == 0
            %td.right.aligned -
          - else
            %td.right.aligned= stat.fetch(field).round(0) { '-' }

%h4 Development characteristic summation, by project status

%table.ui.celled.table.unstackable
  %thead
    %tr
      %th
      - @search.status_keys.each do |name|
        %th= name.titleize
  %tbody
    %tr.active
      %td
        Total number of projects
      - @search.status_keys.each do |key|
        %td.right.aligned= @search.statuses.send(key).fetch(:count)
    - @search.boolean_fields.each do |field|
      %tr
        %td= Development.human_attribute_name field
        - @search.status_keys.each do |key|
          - stat = @search.statuses.send(key)
          - if stat.fetch(:count) == 0
            %td.center.aligned -
          - else
            %td.right.aligned
              #{stat.fetch(field)} (#{ ((stat.fetch(field) / stat.fetch(:count).to_f) * 100).round(2) }%)

#footer
  %p
    This summary report was generated by
    = link_to "MassBuilds (#{root_url})", root_url
    based on the following search criteria:

  %ul
    - @search.criteria.each do |field, v|
      %li #{Development.human_attribute_name(field)} = #{v}

  %p
    Through MassBuilds, the Metropolitan Area Planning Council
    collects high-quality data on development activity across the Commonwealth
    of Massachusetts.

  %p
    View the latest version of this report at
    - report_url = export_developments_url(@search.query.merge({ format: :pdf }))
    = link_to report_url, report_url
  -# NOT QUITE READY
  -# %p
  -#   View and refine this search at
  -#   - search_url = developments_url(@search.query)
  -#   = link_to search_url, search_url
  %p
    Download the development data as CSV:
    - csv_url = export_developments_url(@search.query.merge({ format: :csv }))
    = link_to csv_url, csv_url
%br
%br

-# TODO: Provide a link to DD itself from here.

:javascript

  var map = L.map('map', { zoomControl:false }).setView([42.359,-71.137], 10);
  const ATTRIBUTION = 'Map tiles by <a href="http://mapc.org">MAPC</a>, ' +
                  'Data by <a href="http://www.mass.gov/mgis/">MassGIS</a>.';

  L.tileLayer('http://tiles.mapc.org/basemap/{z}/{x}/{y}.png', {
    minZoom: 9,
    maxZoom: 17,
    attribution: ATTRIBUTION
  }).addTo(map);

  var dotIcon = L.icon({
    iconUrl: 'https://camo.githubusercontent.com/137174e450145056378a39e3c3f065c8927c8a01/687474703a2f2f73746f726167652e676f6f676c65617069732e636f6d2f737570706f72742d6b6d732d70726f642f534e505f323735323036385f656e5f7630'
  })

  var markers = [#{@search.markers}]

  var group = new L.featureGroup(markers).addTo(map);

  map.fitBounds(group.getBounds());
